---
title: "HBN_data"
output: html_document
date: "2025-05-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Reproducible brain charts HBN dataset download

```{bash}
#Make a data directory to hold your data files
mkdir data
cd data

# Clone the HBN directory into the data directory
  datalad clone https://github.com/ReproBrainChart/HBN_FreeSurfer.git \
    -b complete-pass-0.1

#Download all .tsv files
cd HBN_FreeSurfer/freesurfer
find . -name "*.tsv" -exec datalad get {} +

#Make a directory to store all the .tsv files

mkdir -p ../HBN_tsv

#Make a sub-drectory for the brainmeasures tsv and the regional surface stats tv
cd HBN_tsv
mkdir brainmeasures_tsv
mkdir regionsurfacestats_tsv

find . -name "*regionsurfacestats.tsv" -exec cp {} HBN_tsv/regional_stats_tsv/ \;
find . -name "*brainmeasures.tsv" -exec cp {} HBN_tsv/brainmeasures_tsv/ \;
```


## Create directory files and working directories for your data to get stored 

```{r}
library(tidyverse)

# Set the directory containing the .tsv files
brainmeasures_tsv_dir <- "/Users/jiyashah/Data/HBN_tsv/brainmeasures_tsv"

# List all .tsv files
brainmeasures_tsv_files <- list.files(brainmeasures_tsv_dir, pattern = "\\.tsv$", full.names = TRUE)

# Read and combine all files without storing the filename
combined_df <- map_df(brainmeasures_tsv_files, ~ read_tsv(.x, show_col_types = FALSE))

# Preview combined data
print(combined_df)

# Create a new csv file with the combined data 
write_csv(combined_df, "/Users/jiyashah/Data/HBN_tsv/combined_brainmeasures.csv")

```

```{r}
# Set the directory containing the .tsv files
regionsurfacestats_tsv_dir <- "/Users/jiyashah/Data/HBN_tsv/regionsurfacestats_tsv"

# List all .tsv files
regionsurfacestats_tsv_files <- list.files(regionsurfacestats_tsv_dir, pattern = "\\.tsv$", full.names = TRUE)

# Read and combine all files without storing the filename
regions_combined_df <- map_df(regionsurfacestats_tsv_files, ~ read_tsv(.x, show_col_types = FALSE))

# Preview combined data
print(regions_combined_df)

# Create a new csv file with the combined data 
write_csv(regions_combined_df, "/Users/jiyashah/Data/HBN_tsv/combined_regionsurfacestats.csv")
```
## reshape regional data
```{r}
atlas_list <- unique(regions_combined_df$atlas)

print(atlas_list)

```
```{r}
reshape_atlas_wide <- function(df, atlas_name) {
  df %>%
    filter(atlas == atlas_name, !is.na(StructName), StructName != "") %>%
    select(subject_id, session_id, hemisphere, StructName,
           NumVert, SurfArea, GrayVol, ThickAvg, ThickStd, MeanCurv,
           GausCurv, FoldInd, CurvInd, Index, SegId,
           Mean_wgpct, StdDev_wgpct, Min_wgpct, Max_wgpct, Range_wgpct, SNR_wgpct,
           Mean_piallgi, StdDev_piallgi, Min_piallgi, Max_piallgi, Range_piallgi) %>%
    
    # Reshape
    pivot_longer(cols = -c(subject_id, session_id, hemisphere, StructName),
                 names_to = "metric", values_to = "value") %>%
    mutate(column_name = paste0(hemisphere, "_", StructName, "_", metric)) %>%
    select(subject_id, session_id, column_name, value) %>%
    group_by(subject_id, session_id, column_name) %>%
    summarise(value = mean(value, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = column_name, values_from = value)
}


```

```{r}
# Directory to save reshaped CSVs
output_dir <- "/Users/jiyashah/Data/"
dir.create(output_dir, showWarnings = FALSE)

walk(atlas_list, function(atlas_name) {
  message("Processing: ", atlas_name)
  reshaped_df <- reshape_atlas_wide(regions_combined_df, atlas_name)
  write_csv(reshaped_df, file.path(output_dir, paste0("atlas_", atlas_name, "_wide.csv")))
})

```

